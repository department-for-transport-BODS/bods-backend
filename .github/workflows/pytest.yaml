name: pytest
on:
  pull_request:
    branches:
      - "dev"
      - "!test"
      - "!main"
    paths:
      - "src/**"
      - "tests/**"

jobs:
  pytest:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      statuses: write
      checks: write
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: Install poetry
        run: pipx install poetry
      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
          cache: "poetry"
      - name: Install Dependencies (Poetry)
        run: |
          poetry install
      - name: Install pytest PR annotation plugin
        run: poetry run pip install pytest-github-actions-annotate-failures
      - name: Run Pytest
        run: poetry run pytest --junitxml=junit/test-results.xml --cov-report term
      - name: Generate Test Summary
        id: test_summary
        uses: test-summary/action@31493c76ec9e7aa675f1585d3ed6f1da69269a86 # v2.4
        if: always()
        with:
          paths: junit/*.xml
      # Test Results Check
      - name: Prepare Test Summary
        if: always()
        id: prepare_test_summary
        run: |
          passed=${{ steps.test_summary.outputs.passed }}
          failed=${{ steps.test_summary.outputs.failed }}
          skipped=${{ steps.test_summary.outputs.skipped }}
          total=${{ steps.test_summary.outputs.total }}

          conclusion="success"
          if [ "$failed" -gt 0 ]; then
            conclusion="failure"
          fi

          title="Passed: $passed, Failed: $failed, Skipped: $skipped, Total: $total"

          if [ "$total" -gt 0 ]; then
            pass_rate=$(echo "scale=2; ($passed * 100) / $total" | bc)
            summary=$(cat << EOF
            ### Test Results

            - Pass Rate: ${pass_rate}%
            - Passed: $passed tests
            - Failed: $failed tests
            - Skipped: $skipped tests
            - Total: $total tests
            EOF
            )
          else
            summary="No tests were run"
          fi

          echo "title=$title" >> $GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "conclusion=$conclusion" >> $GITHUB_OUTPUT

      - name: Create Test Check
        if: always()
        uses: ./.github/actions/create-check
        with:
          name: "Tests"
          title: ${{ steps.prepare_test_summary.outputs.title }}
          summary: ${{ steps.prepare_test_summary.outputs.summary }}
          conclusion: ${{ steps.prepare_test_summary.outputs.conclusion }}
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.sha }}

      # Coverage Check
      - name: Extract Coverage
        if: always()
        id: extract_coverage
        shell: bash
        run: |
          poetry run coverage json -q -o cov.json

          coverage_percentage=$(jq -r .totals.percent_covered_display cov.json)
          num_statements=$(jq .totals.num_statements cov.json)
          missing_lines=$(jq .totals.missing_lines cov.json)
          excluded_lines=$(jq .totals.excluded_lines cov.json)
          num_branches=$(jq .totals.num_branches cov.json)
          num_partial_branches=$(jq .totals.num_partial_branches cov.json)
          covered_branches=$(jq .totals.covered_branches cov.json)
          missing_branches=$(jq .totals.missing_branches cov.json)

          echo "coverage=$coverage_percentage" >> $GITHUB_OUTPUT

          title="Coverage: $coverage_percentage%"

          summary=$(cat << EOF
          ### Coverage Report
          - Total Statements: $num_statements
          - Missing Lines: $missing_lines
          - Excluded Lines: $excluded_lines
          - Total Branches: $num_branches
          - Partial Branches: $num_partial_branches
          - Covered Branches: $covered_branches
          - Missing Branches: $missing_branches
          EOF
          )

          echo "title=$title" >> $GITHUB_OUTPUT
          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$summary" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          if (( $(echo "$coverage_percentage < 90" | bc -l) )); then
            echo "conclusion=failure" >> $GITHUB_OUTPUT
          else
            echo "conclusion=success" >> $GITHUB_OUTPUT
          fi
      - name: Create Coverage Check
        if: always()
        uses: ./.github/actions/create-check
        with:
          name: "Coverage"
          title: ${{ steps.extract_coverage.outputs.title }}
          summary: ${{ steps.extract_coverage.outputs.summary }}
          conclusion: ${{ steps.extract_coverage.outputs.conclusion }}
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-sha: ${{ github.event.pull_request.head.sha || github.sha }}
