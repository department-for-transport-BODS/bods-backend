{
  "StartAt": "ProcessInput",
  "States": {
    "ProcessInput": {
      "Type": "Pass",
      "ResultPath": "$",
      "Parameters": { "detail.$": "$[0].detail" },
      "Next": "InitializePipeline"
    },
    "InitializePipeline": {
      "Type": "Task",
      "Resource": "${InitializePipelineLambdaArn}",
      "Parameters": {
        "Bucket.$": "$.Bucket",
        "ObjectKey.$": "$.Key",
        "DatasetRevisionId.$": "$.DatasetRevisionId"
      },
      "ResultPath": "$.fileValidation",
      "Next": "SchemaCheck",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ParseError",
          "ResultPath": "$.error_info"
        }
      ]
    },
    "DownloadDataset": {
      "Type": "Task",
      "Resource": "${DownloadDatasetLambdaArn}",
      "Parameters": {
        "Bucket.$": "$.Bucket",
        "ObjectKey.$": "$.Key",
        "DatasetRevisionId.$": "$.DatasetRevisionId",
        "ValidationResult.$": "$.fileValidation"
      },
      "ResultPath": "$.schemaCheck",
      "Next": "PostSchemaCheck",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ParseError",
          "ResultPath": "$.error_info"
        }
      ]
    },
    "ClamAvScanner": {
      "Type": "Task",
      "Resource": "${ClamAvScannerLambdaArn}",
      "Parameters": {
        "Bucket.$": "$.Bucket",
        "ObjectKey.$": "$.Key",
        "DatasetRevisionId.$": "$.DatasetRevisionId",
        "SchemaCheckResult.$": "$.schemaCheck"
      },
      "ResultPath": "$.postSchemaCheck",
      "Next": "FileAttributesEtl",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ParseError",
          "ResultPath": "$.error_info"
        }
      ]
    },
    "FileLevelProcessing": {
      "Type": "Map",
      "Parameters": {
        "Bucket.$": "$.Bucket",
        "ObjectKey.$": "$.Key",
        "DatasetRevisionId.$": "$.DatasetRevisionId",
        "PostSchemaCheckResult.$": "$.postSchemaCheck"
      },
      "ResultPath": "$.fileAttributesEtl",
      "Next": "PtiValidation",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ExceptionHandler"
        }
      ]
    },
    "PtiValidation": {
      "Type": "Task",
      "Resource": "${PtiValidationLambdaArn}",
      "Parameters": {
        "Bucket.$": "$.Bucket",
        "ObjectKey.$": "$.Key",
        "DatasetRevisionId.$": "$.DatasetRevisionId",
        "FileAttributesResult.$": "$.fileAttributesEtl"
      },
      "ResultPath": "$.ptiValidation",
      "Next": "ETLProcess",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ExceptionHandler"
        }
      ]
    },
    "ETLProcess": {
      "Type": "Task",
      "Resource": "${ETLProcessLambdaArn}",
      "Parameters": {
        "Bucket.$": "$.Bucket",
        "ObjectKey.$": "$.Key",
        "DatasetRevisionId.$": "$.DatasetRevisionId",
        "fileAttributesId.$": "$.fileAttributesEtl.id",
        "DatasetEtlTaskResultId.$": "$.DatasetEtlTaskResultId",
        "ValidationResult.$": "$.ptiValidation"
      },
      "ResultPath": "$.etlProcess",
      "Next": "Success",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ExceptionHandler"
        }
      ]
    },
    "Success": {
      "Type": "Succeed"
    },
    "ExceptionHandler": {
      "Type": "Task",
      "Resource": "${ExceptionHandlerLambdaArn}",
      "Parameters": {
        "Bucket.$": "$.Bucket",
        "ObjectKey.$": "$.Key",
        "ErrorInfo.$": "$"
      },
      "End": true
    }
  }
}
