{
  "StartAt": "ProcessInput",
  "QueryLanguage": "JSONata",
  "States": {
    "ProcessInput": {
      "Type": "Pass",
      "Assign": {
        "detail": {
          "inputDataSource": "{% $$.inputDataSource %}",
          "datasetRevisionId": "{% $$.datasetRevisionId %}",
          "datasetType": "{% $$.datasetType %}",
          "url": "{% $$.url %}",
          "bucket": {
            "name": "{% $$.bucket ? $$.bucket : $$.S3Bucket %}"
          },
          "s3": "{% $$.s3 %}"
        }
      },
      "Next": "RouteByInputType"
    },
    "RouteByInputType": {
      "Type": "Choice",
      "Choices": [
        {
          "Condition": "{% $$.detail.inputDataSource = 'URL_DOWNLOAD' %}",
          "Next": "DownloadDataset"
        }
      ],
      "Default": "InitializePipeline"
    },
    "DownloadDataset": {
      "Type": "Task",
      "Resource": "${DownloadDatasetLambdaArn}",
      "Arguments": {
        "Url": "{% $$.detail.url %}",
        "Bucket": "{% $$.detail.bucket.name %}",
        "DatasetType": "{% $$.detail.datasetType %}",
        "DatasetRevisionId": "{% $$.detail.datasetRevisionId %}"
      },
      "Output": {
        "detail": {
          "inputDataSource": "S3_FILE",
          "datasetRevisionId": "{% $$.detail.datasetRevisionId %}",
          "datasetType": "{% $$.detail.datasetType %}",
          "bucket": {
            "name": "{% $$.detail.bucket.name %}"
          },
          "object": {
            "key": "{% $states.result.objectKey %}"
          }
        }
      },
      "Next": "InitializePipeline",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ParentExceptionHandler"
        }
      ]
    },
    "InitializePipeline": {
      "Type": "Task",
      "Resource": "${InitializePipelineLambdaArn}",
      "Arguments": {
        "Bucket": "{% $$.detail.bucket.name %}",
        "ObjectKey": "{% $$.detail.object.key %}",
        "DatasetRevisionId": "{% $$.detail.datasetRevisionId %}"
      },
      "Output": {
        "initializePipeline": "{% $states.result %}",
        "detail": "{% $$.detail %}"
      },
      "Next": "ClamAvScanner",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ParentExceptionHandler",
          "Output": {
            "errorInfo": {
              "Error": "{% $error %}",
              "Cause": "{% $cause %}"
            }
          }
        }
      ]
    },
    "ClamAvScanner": {
      "Type": "Task",
      "Resource": "${ClamAvScannerLambdaArn}",
      "Arguments": {
        "Bucket": "{% $$.detail.bucket.name %}",
        "ObjectKey": "{% $$.detail.object.key %}",
        "DatasetRevisionId": "{% $$.detail.datasetRevisionId %}",
        "DatasetType": "{% $$.detail.datasetType %}"
      },
      "Output": {
        "scanner": "{% $states.result %}",
        "detail": "{% $$.detail %}"
      },
      "Next": "FileLevelProcessing",
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ParentExceptionHandler"
        }
      ]
    },
    "FileLevelProcessing": {
      "Type": "Map",
      "ItemReader": {
        "Resource": "arn:aws:states:::s3:listObjectsV2",
        "Arguments": {
          "Bucket": "{% $$.detail.bucket.name %}",
          "Prefix": "{% $$.scanner.body.generatedPrefix %}"
        }
      },
      "ResultWriter": {
        "Resource": "arn:aws:states:::s3:putObject",
        "Arguments": {
          "Bucket": "{% $$.detail.bucket.name %}",
          "Prefix": "tt-etl-map-results"
        }
      },
      "ItemProcessor": {
        "ProcessorConfig": {
          "Mode": "DISTRIBUTED",
          "ExecutionType": "STANDARD"
        },
        "StartAt": "FileValidation",
        "States": {
          "FileValidation": {
            "Type": "Task",
            "Resource": "${FileValidationLambdaArn}",
            "Arguments": {
              "Bucket": "{% $.Bucket %}",
              "ObjectKey": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}"
            },
            "Output": {
              "fileValidation": "{% $states.result %}",
              "Bucket": "{% $.Bucket %}",
              "Key": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}"
            },
            "Next": "SchemaCheck",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "ExceptionHandler",
                "Output": {
                  "errorInfo": {
                    "Error": "{% $error %}",
                    "Cause": "{% $cause %}"
                  }
                }
              }
            ]
          },
          "SchemaCheck": {
            "Type": "Task",
            "Resource": "${SchemaCheckLambdaArn}",
            "Arguments": {
              "Bucket": "{% $.Bucket %}",
              "ObjectKey": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}",
              "ValidationResult": "{% $.fileValidation %}"
            },
            "Output": {
              "schemaCheck": "{% $states.result %}",
              "fileValidation": "{% $.fileValidation %}",
              "Bucket": "{% $.Bucket %}",
              "Key": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}"
            },
            "Next": "PostSchemaCheck",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "ExceptionHandler",
                "Output": {
                  "errorInfo": {
                    "Error": "{% $error %}",
                    "Cause": "{% $cause %}"
                  }
                }
              }
            ]
          },
          "PostSchemaCheck": {
            "Type": "Task",
            "Resource": "${PostSchemaCheckLambdaArn}",
            "Arguments": {
              "Bucket": "{% $.Bucket %}",
              "ObjectKey": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}",
              "SchemaCheckResult": "{% $.schemaCheck %}"
            },
            "Output": {
              "postSchemaCheck": "{% $states.result %}",
              "schemaCheck": "{% $.schemaCheck %}",
              "Bucket": "{% $.Bucket %}",
              "Key": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}"
            },
            "Next": "FileAttributesEtl",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "ExceptionHandler",
                "Output": {
                  "errorInfo": {
                    "Error": "{% $error %}",
                    "Cause": "{% $cause %}"
                  }
                }
              }
            ]
          },
          "FileAttributesEtl": {
            "Type": "Task",
            "Resource": "${FileAttributesEtlLambdaArn}",
            "Arguments": {
              "Bucket": "{% $.Bucket %}",
              "ObjectKey": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}",
              "PostSchemaCheckResult": "{% $.postSchemaCheck %}"
            },
            "Output": {
              "fileAttributesEtl": "{% $states.result %}"
            },
            "Next": "PtiValidation",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "ExceptionHandler",
                "Output": {
                  "errorInfo": {
                    "Error": "{% $error %}",
                    "Cause": "{% $cause %}"
                  }
                }
              }
            ]
          },
          "PtiValidation": {
            "Type": "Task",
            "Resource": "${PtiValidationLambdaArn}",
            "Arguments": {
              "Bucket": "{% $.Bucket %}",
              "ObjectKey": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}",
              "TxcFileAttributesId": "{% $.fileAttributesEtl.id %}"
            },
            "Output": {
              "ptiValidation": "{% $states.result %}",
              "fileAttributesEtl": "{% $.fileAttributesEtl %}",
              "Bucket": "{% $.Bucket %}",
              "Key": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}"
            },
            "Next": "ETLProcess",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "ExceptionHandler",
                "Output": {
                  "errorInfo": {
                    "Error": "{% $error %}",
                    "Cause": "{% $cause %}"
                  }
                }
              }
            ]
          },
          "ETLProcess": {
            "Type": "Task",
            "Resource": "${ETLProcessLambdaArn}",
            "Arguments": {
              "Bucket": "{% $.Bucket %}",
              "ObjectKey": "{% $.Key %}",
              "DatasetRevisionId": "{% $.DatasetRevisionId %}",
              "fileAttributesId": "{% $.fileAttributesEtl.id %}",
              "DatasetEtlTaskResultId": "{% $.DatasetEtlTaskResultId %}",
              "ValidationResult": "{% $.ptiValidation %}"
            },
            "Output": {
              "etlProcess": "{% $states.result %}",
              "fileAttributesEtl": "{% $.fileAttributesEtl %}",
              "ptiValidation": "{% $.ptiValidation %}"
            },
            "Next": "Success",
            "Catch": [
              {
                "ErrorEquals": ["States.ALL"],
                "Next": "ExceptionHandler",
                "Output": {
                  "errorInfo": {
                    "Error": "{% $error %}",
                    "Cause": "{% $cause %}"
                  }
                }
              }
            ]
          },
          "Success": {
            "Type": "Succeed"
          },
          "ExceptionHandler": {
            "Type": "Task",
            "Resource": "${ExceptionHandlerLambdaArn}",
            "Arguments": {
              "Error": "{% $.errorInfo.Error %}",
              "Cause": "{% $parse($.errorInfo.Cause) %}",
              "DatasetEtlTaskResultId": "{% $.DatasetEtlTaskResultId %}"
            },
            "Next": "Fail"
          },
          "Fail": {
            "Type": "Fail"
          }
        }
      },
      "MaxConcurrency": 1000,
      "ToleratedFailurePercentage": 100,
      "Next": "GenerateOutputZip",
      "Output": {
        "mapResults": "{% $states.result %}",
        "detail": "{% $states.input.detail %}",
        "scanner": "{% $states.input.scanner %}"
      }
    },
    "GenerateOutputZip": {
      "Type": "Task",
      "Resource": "${GenerateOutputZipLambdaArn}",
      "Arguments": {
        "MapRunArn": "{% $states.input.mapResults.MapRunArn %}",
        "DestinationBucket": "{% $states.input.detail.bucket.name %}",
        "OutputPrefix": "{% $states.input.scanner.body.generatedPrefix %}",
        "DatasetRevisionId": "{% $states.input.detail.datasetRevisionId %}",
        "OriginalObjectKey": "{% $states.input.detail.object.key %}"
      },
      "End": true,
      "Catch": [
        {
          "ErrorEquals": ["States.ALL"],
          "Next": "ParentExceptionHandler",
          "Output": {
            "errorInfo": {
              "Error": "{% $error %}",
              "Cause": "{% $cause %}"
            }
          }
        }
      ]
    },
    "ParentExceptionHandler": {
      "Type": "Task",
      "Resource": "${ExceptionHandlerLambdaArn}",
      "Arguments": {
        "Error": "{% $states.input.errorInfo.Error %}",
        "Cause": "{% $states.input.errorInfo.Cause %}",
        "DatasetEtlTaskResultId": "{% $states.input.initializePipeline.DatasetEtlTaskResultId %}"
      },
      "End": true
    }
  }
}
